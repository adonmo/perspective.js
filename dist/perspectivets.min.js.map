{"version":3,"file":"perspectivets.min.js","sources":["../src/index.ts"],"sourcesContent":["/*!\nCopyright 2010 futomi <http://www.html5.jp/>\nCopyright 2014 Fabien LOISON <http://www.flozz.fr/>\nCopyright 2021 Adonmo <https://www.adonmo.com/>\nCopyright 2021 Aarni Koskela <https://github.com/akx>\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\nhttp://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nexport interface Quadrilateral {\n  topLeftX: number;\n  topLeftY: number;\n  topRightX: number;\n  topRightY: number;\n  bottomRightX: number;\n  bottomRightY: number;\n  bottomLeftX: number;\n  bottomLeftY: number;\n}\n\n\nfunction createCanvasContext(width: number, height: number): CanvasRenderingContext2D {\n  const canvas = document.createElement(\"canvas\");\n  canvas.width = width;\n  canvas.height = height;\n  // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n  return canvas.getContext(\"2d\")!;\n}\n\nfunction applyMask(ctx: CanvasRenderingContext2D, {\n  bottomLeftX,\n  bottomLeftY,\n  bottomRightX,\n  bottomRightY,\n  topLeftX,\n  topLeftY,\n  topRightX,\n  topRightY\n}: Quadrilateral): void {\n  ctx.beginPath();\n  ctx.moveTo(topLeftX, topLeftY);\n  ctx.lineTo(topRightX, topRightY);\n  ctx.lineTo(bottomRightX, bottomRightY);\n  ctx.lineTo(bottomLeftX, bottomLeftY);\n  ctx.closePath();\n  ctx.globalCompositeOperation = \"destination-in\";\n  ctx.fill();\n  ctx.globalCompositeOperation = \"source-over\";\n}\n\nfunction drawSlice(\n  originalCanvas: HTMLCanvasElement,\n  tempContext: CanvasRenderingContext2D,\n  targetContext: CanvasRenderingContext2D,\n  tx: number,\n  ty: number,\n  sx: number,\n  sy: number,\n  ag: number,\n  sc: number,\n) {\n  tempContext.setTransform(1, 0, 0, 1, tx, ty);\n  tempContext.drawImage(originalCanvas, 0, 0);\n  targetContext.translate(sx, sy);\n  targetContext.rotate(ag);\n  targetContext.scale(sc, sc);\n  targetContext.drawImage(tempContext.canvas, 0, 0);\n  targetContext.setTransform(1, 0, 0, 1, 0, 0);\n}\n\nfunction drawSlices(\n  originalCanvas: HTMLCanvasElement,\n  tempContext: CanvasRenderingContext2D,\n  transformedContext: CanvasRenderingContext2D,\n  isYDirection: boolean,\n  width: number,\n  height: number,\n  step: number,\n  sx0: number,\n  sx1: number,\n  sy0: number,\n  sy1: number,\n  ex0: number,\n  ex1: number,\n  ey0: number,\n  ey1: number,\n): void {\n  const extent = (isYDirection ? height : width);\n  for (let i = 0; i < extent; i += step) {\n    const r = i / extent;\n    const sx = sx0 + (sx1 - sx0) * r;\n    const sy = sy0 + (sy1 - sy0) * r;\n    const ex = ex0 + (ex1 - ex0) * r;\n    const ey = ey0 + (ey1 - ey0) * r;\n    const ag = isYDirection ? Math.atan((ey - sy) / (ex - sx)) : Math.atan((sx - ex) / (ey - sy));\n    const sc = Math.hypot(ex - sx, ey - sy) / width;\n    const tx = isYDirection ? 0 : -i;\n    const ty = isYDirection ? -i : 0;\n    drawSlice(originalCanvas, tempContext, transformedContext, tx, ty, sx, sy, ag, sc);\n  }\n}\n\nexport default class Perspective {\n  // Context for destination (output will go here)\n  private readonly destinationContext: CanvasRenderingContext2D;\n\n  // Canvas for original image\n  private readonly originalCanvas: HTMLCanvasElement;\n\n  // Context for transformed image\n  private readonly transformedContext: CanvasRenderingContext2D;\n\n  constructor(destinationContext: CanvasRenderingContext2D, image: HTMLImageElement) {\n    // check the arguments\n    if (!destinationContext || !destinationContext.strokeStyle || !image || !image.width || !image.height) {\n      throw new Error(\"Invalid arguments\");\n    }\n    this.destinationContext = destinationContext;\n    // prepare a <canvas> for the image\n    const cvso = document.createElement(\"canvas\");\n    cvso.width = Math.round(image.width);\n    cvso.height = Math.round(image.height);\n    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n    const ctxo = cvso.getContext(\"2d\")!;\n    ctxo.drawImage(image, 0, 0, cvso.width, cvso.height);\n    this.originalCanvas = cvso;\n    // prepare a <canvas> for the transformed image\n    const destinationCanvas = destinationContext.canvas;\n    this.transformedContext = createCanvasContext(destinationCanvas.width, destinationCanvas.height);\n  }\n\n  public draw(q: Quadrilateral, step = 2): void {\n    const {\n      topLeftX,\n      topLeftY,\n      topRightX,\n      topRightY,\n      bottomRightX,\n      bottomRightY,\n      bottomLeftX,\n      bottomLeftY,\n    } = q;\n\n    // compute the dimension of each side\n    const dims = [\n      Math.hypot(topLeftX - topRightX, topLeftY - topRightY), // top side\n      Math.hypot(topRightX - bottomRightX, topRightY - bottomRightY), // right side\n      Math.hypot(bottomRightX - bottomLeftX, bottomRightY - bottomLeftY), // bottom side\n      Math.hypot(bottomLeftX - topLeftX, bottomLeftY - topLeftY), // left side\n    ];\n    const { width, height } = this.originalCanvas;\n    // specify the index of which dimension is longest\n    let base_index = 0;\n    let max_scale_rate = 0;\n    let zero_num = 0;\n    for (let i = 0; i < 4; i++) {\n      const dim = dims[i];\n      const rate = i % 2 ? dim / width : dim / height;\n      if (rate > max_scale_rate) {\n        base_index = i;\n        max_scale_rate = rate;\n      }\n      if (dim == 0) {\n        zero_num++;\n      }\n    }\n    if (zero_num > 1) {\n      return;\n    }\n    const coverStep = step * 5;\n    const { originalCanvas, transformedContext, destinationContext } = this;\n    const transformedCanvas = transformedContext.canvas;\n    transformedContext.clearRect(0, 0, transformedCanvas.width, transformedCanvas.height);\n    if (base_index % 2 == 0) {\n      // top or bottom side\n      const ctxl = createCanvasContext(width, coverStep);\n      ctxl.globalCompositeOperation = \"copy\";\n      drawSlices(originalCanvas, ctxl, transformedContext, true, width, height, step, topLeftX, bottomLeftX, topLeftY, bottomLeftY, topRightX, bottomRightX, topRightY, bottomRightY);\n    } else {\n      // right or left side\n      const ctxl = createCanvasContext(coverStep, height);\n      ctxl.globalCompositeOperation = \"copy\";\n      drawSlices(originalCanvas, ctxl, transformedContext, false, width, height, step, topLeftX, topRightX, topLeftY, topRightY, bottomLeftX, bottomRightX, bottomLeftY, bottomRightY);\n    }\n    // set a clipping path and draw the transformed image on the destination canvas.\n    destinationContext.save();\n    destinationContext.drawImage(transformedCanvas, 0, 0);\n    applyMask(destinationContext, q);\n    destinationContext.restore();\n  }\n}\n"],"names":["createCanvasContext","width","height","canvas","document","createElement","getContext","drawSlice","originalCanvas","tempContext","targetContext","tx","ty","sx","sy","ag","sc","setTransform","drawImage","translate","rotate","scale","drawSlices","transformedContext","isYDirection","step","sx0","sx1","sy0","sy1","ex0","ex1","ey0","ey1","extent","i","r","ex","ey","Math","atan","hypot","destinationContext","image","strokeStyle","Error","this","cvso","round","destinationCanvas","Perspective","q","topLeftX","topLeftY","topRightX","topRightY","bottomRightX","bottomRightY","bottomLeftX","bottomLeftY","dims","_a","base_index","max_scale_rate","zero_num","dim","rate","ctxl","coverStep","_b","transformedCanvas","clearRect","globalCompositeOperation","save","ctx","beginPath","moveTo","lineTo","closePath","fill","applyMask","restore"],"mappings":"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"}